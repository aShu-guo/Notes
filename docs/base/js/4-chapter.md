# 表达式与操作符

## 基本(primary)表达式

指最基本的、无法再分的表达式，包含三种：

- 字面量：数值字面量、字符串字面量等等
- 一部分保留字：true、false、null、undefined等
- 变量、常量和全局对象的引用：arr、i、global object

## 对象、数组初始化表达式

又称为对象字面量、数组字面量

```js
const obj = {};

const obj2 = {
  name: '',
  value: 1,
};
```

```js
const arr = [];

const arr2 = [1, 2, , , 3];
```

## 函数定义表达式

又称为函数字面量

```js
const add = function (a, b) {
  return a + b;
};
```

## 属性访问表达式

包含两种形式，分别是静态的和动态的

- `expression.identifier`
- `expression[expression]`

形式一更加简洁，但是在需要`事先`知道`要访问属性的标识符`。形式二要访问的属性则是`动态计算`的，并且方括号中的表达`一定`会被解释为`字符串`

### 条件式属性访问

又称为可选链

- `expression?.identifier`
- `expression?.[expression]`

在JS中，`null和undefined`是唯二没有属性的值，那么如果变量为其中一个，在访问属性时会抛出TypeError，但是`可选链`可以防止这种错误发生

支持引用或者函数

```js
const a = { b: null };
console.log(a.b?.c);
console.log(a.b?.['c']);
// output： undefined
```

```js
a.func?.(...args);
```

:::warning
注意这里只会检测fun是否为null和undefined，并不会检查它是否是一个函数。
:::

在访问`值可能`为null和undefined的`变量属性`时，添加可选链是一个最佳实践。

可选链表达式等价于

```js
a.b === null || a.b === undefined ? undefined : a.b.c;
```

可以将可选链表达式理解为一个电路通道，当短路时返回`undefined`，反之则正常通过（即正常访问属性）

## 调用表达式

指调用函数或方法的语法

```js
fun(1);
[(1, 2, 3)].sort();
```

调用表达式时，执行流程如下：

1. 首先求值函数表达式，然后求值参数列表。如果函数表达式的值不是函数，则抛出TypeError。
2. 接着按照参数列表的顺序给参数赋值
3. 之后执行函数体

如果函数体中return了值，则执行结果为这个值。反之则为undefined

:::info

- 附着在其附属对象上调用时，我们称其为“方法”，例如面向对象编程时
- 直接调用则称为“函数”

:::

:::warning

注意使用了可选链调用的函数或方法与不使用的区别如下：

根据调用表达式的执行步骤可知：当非可选链调用时，`计算出函数表达式和参数列表表达式的值之后`才会执行函数体，那么即使`函数表达式最终计算出的值并不是函数类型`，参数列表中的表达式也已经执行了

而可选链调用时，如果它的值为`null`和`undefined`则会短路掉，便不会再去执行参数列表中的表达式。

```js
let fun = null,
  x = 0;
try {
  fun(x++);
} catch (e) {
  console.log(x);
}

fun?.(x++);
console.log(x);

// output：
// 1
// 1
```

:::

## 实例化表达式

```js
new Object();
```

如果实例化时，不需要传递任何参数，则可以省略圆括号

```js
new Object();
```

:::info
虽然省略圆括号也可以实例化，但是最好带上圆括号保持格式统一
:::

## 操作符概述

![img.png](/imgs/base/js/expression.png)

![img.png](/imgs/base/js/expression-1.png)

### 操作数个数

可以根据操作数个数进行分类：假如需要的操作数个数为n，则称该操作符为n元操作符。

例如：

- -x只有一个操作符（取x的负值），因此为一元操作符
- \*是二元操作符
- ?:为三元操作符

### 操作数与结果类型

有些操作符适用于任何类型的值，但是多数操作符期待自己的`操作数`是`某种特定类型`，也期待结果是`某种特定类型`。表4-1中的类型一栏：

```text
输入类型 -> 输出类型

例如：
num -> num 表示：期待输入类型是number类型，输出也是number类型

```

在对操作数进行操作符对应的运算之前，首先会根据操作符期待的输入类型进行数据转换，转换规则如下：

![img.png](/imgs/base/js/expression-2.png)

当然也有写操作符会根据操作数的类型不同而不同，例如：`+操作符`（既可以拼接字符串，又可以进行数值加减）、`<操作符`（可以根据数值大小排序，也可以通过字符顺序排序）

```js
// 拼接字符串
'3' + '3';
// output: '33'

// 数值加减
3 + 3;
// output: 6

// 字符串与数值
3 + '3';
// output：'33'
```

:::info

其中`lval`表示左值表达式，即可以合法的出现在赋值表达式（即`=`）左侧的表达式。

在js中，变量、对象属性和数组元素都是左值
:::

### 操作符副效应

副效应（side effect）：操作符对应的运算可能影响将来的求值。例如：赋值(=)、递增(++)、递减(--)、delete操作符

其他操作符则没有负效应，但是函数调用和对象创建表达式是否有副效应，取决与函数或构造函数内部是否使用了有副效应的操作符。

### 优先级

4-1表格按照优先级`从高到低排列`，而且用横线对相同优先级的操作符进行了分组

但是操作符的优先级可以通过圆括号`()`改变：

```js
(1 + 2) * 3;
```

### 求值顺序

求值顺序只会在一种情况下有差异：操作符有副效应，例如递增、递减

## 算数操作数

包含`**`、`*`、`+`、`-`、`/`、`%`等6种基本操作符。

在必要时会将输入值转换为数值类型，再进行操作。如果无法转换，则输出NaN。而且如果操作数为NaN，结果几乎都是NaN

### +操作符

二元+操作符用于计算数值操作数的和或者拼接字符串操作数

对于两个相同类型的操作数比较简单，但是对于两个不同类型的操作数一般都伴随着类型转换：

1. 获取原始值

- Date调用toString方法获取原始值，其他对象调用valueOf获取原始值
- 如果没有valueOf方法，则调用toString方法获取

2. 计算

如果其中一个操作数为字符串类型，那么则将另一个操作数转换为字符串类型进行拼接

3. 否则两个操作数都转换为数值（或NaN），计算加法



